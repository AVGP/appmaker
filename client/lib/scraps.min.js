if("undefined"!=typeof exports)var Space=require("space"),fs=require("fs"),beautifyHtml=require("js-beautify").html,marked=require("marked");function Element(a,b){this.tag=a;this.attrs=b||{};this.content="";return this}Element.prototype.addClass=function(a){this.attrs["class"]=this.attrs["class"]?this.attrs["class"]+(" "+a):a};Element.prototype.append=function(a){this.content+=a};Element.prototype.attr=function(a,b){this.attrs[a]=b};Element.prototype.html=function(a){this.content+=a};
Element.prototype.toHtml=function(){var a="<"+this.tag,b;for(b in this.attrs)this.attrs.hasOwnProperty(b)&&(a+=" "+b+'="'+this.attrs[b]+'"');a+=">"+this.content;return a+="</"+this.tag+">"};function Scrap(a,b){this.path=a;this.id=a.split(/ /g).pop();this.clear();b instanceof Space||(b=new Space(b));this.patch(b);var c=this.values.scraps;if(c instanceof Space)for(var d in c.keys){var e=c.keys[d];c.values[e]=new Scrap(a+" "+e,c.values[e])}return this}
Scrap.format=function(a,b){return"nl2br"===b?a.replace(/\n/g,"<br>"):"markdown"===b?marked(a):a};Scrap.getPointer=function(a,b){if(!a||"string"===typeof b||!b&&"undefined"===typeof window)return null;b||(b=window);var c=a.split("."),d=c.shift();return!(d in b)?null:!c.length?b[d]:Scrap.getPointer(c.join("."),b[d])};Scrap.replace=function(a,b){return a.replace(/\{\{([_a-zA-Z0-9\.]+)( [^\}]+)?\}\}/g,function(a,d,e){return Scrap.getPointer(d,b)||(e?e.substr(1):"")})};
Scrap.styleToCss=function(a,b,c){a+=" {\n";for(var d in b)b.hasOwnProperty(d)&&(a+="  "+d+" : "+b[d].toString().replace(/\;$/,"")+";\n");return Scrap.replace(a+"}\n",c)};Scrap.styleToInline=function(a,b){var c="",d;for(d in a)a.hasOwnProperty(d)&&(c+=d+": "+a[d].toString().replace(/\;$/,"")+"; ");return Scrap.replace(c,b)};Scrap.events="onblur onchange onclick oncontextmenu onenterkey onfocus onhold onkeydown onkeypress onkeyup onmousedown onmouseout onmouseover onmouseup onorientationchange onsubmit ontouchend ontouchmove ontouchstart".split(/ /);
Scrap.prototype=new Space;Scrap.prototype.clone=function(a){return new Scrap(a,this)};
Scrap.prototype.loop=function(a){if(!this.values.loop||!this.values.scraps)return null;var b=this.values.scraps.toString(),c=this.values.loop;"string"===typeof c&&c.match(/\{\{/)&&(c=Scrap.getPointer(c.replace(/\{|\}/g,""),a));"string"===typeof c&&(c=this.values.loop.split(/ /g));if(!c)return null;c instanceof Space||(c=new Space(c));var d="";c.each(function(c,f){var g={key:c,value:f},h=b.replace(/\{\{([_a-z0-9\.]+)\}\}/gi,function(b,c){var d;return(d=Scrap.getPointer(c,g))?d:Scrap.getPointer(c,a)});
(new Space(h)).each(function(a,b){d+=(new Scrap(a,b)).toHtml()})});this.div.append(d)};Scrap.prototype.selector=function(){return"#"+this.path.replace(/ /g," #")};
Scrap.prototype.setContent=function(a){if(this.values.loop)return this.loop(a);this.values.content&&this.div.html(Scrap.format(Scrap.replace(this.values.content,a),this.values.content_format));if(this.values.styles&&this.values.styles instanceof Space){var b=this.div;this.values.styles.each(function(c,d){b.html(Scrap.styleToCss(c,d.values,a))})}if(this.values.scraps)for(var c in this.values.scraps.keys){var d=this.values.scraps.keys[c];"true"!==this.values.scraps.values[d].values.draft&&this.div.html(this.values.scraps.values[d].toHtml(a))}return this};
Scrap.prototype.setElementTag=function(a){tag=this.values.tag?this.values.tag:"div";this.div=new Element(tag);this.div.attr("id",this.id);var b="checked class disabled draggable dropzone end for height href max maxlength min name origin pattern placeholder readonly rel required selected spellcheck src tabindex target title type width value".split(/ /),c;for(c in b)this.setProperty(b[c],a)};Scrap.prototype.setProperty=function(a,b){this.values[a]&&this.div.attr(a,Scrap.replace(this.values[a],b))};
Scrap.prototype.setScript=function(){for(var a in Scrap.events){var b=Scrap.events[a];this.values[b]&&this.div.attr(b,this.values[b])}};Scrap.prototype.setStyle=function(a){if(!this.values.style)return null;if(!(this.values.style instanceof Space))return this.div.attr("style",this.values.style);this.div.attr("style",Scrap.styleToInline(this.values.style.values,a))};Scrap.prototype.toHtml=function(a){this.setElementTag(a);this.setContent(a);this.setStyle(a);this.setScript(a);return this.div.toHtml()};
function Page(a){this.clear();a&&this.patch(a);this.loadScraps();return this}Page.prototype=new Space;Page.prototype.clone=function(){return new Page(this.values)};Page.prototype.loadScraps=function(){for(var a in this.keys){var b=this.keys[a];this.values[b]=new Scrap(b,this.values[b])}};Page.prototype.request=function(){return!1};
Page.prototype.toHtml=function(a,b){a||(a={});b=b||{};this.request(a);var c;c="<!doctype html>\n<html>";for(var d in this.keys){var e=this.keys[d];"true"!==this.values[e].values.draft&&(c+="\n  "+this.values[e].toHtml(a))}c+="\n</html>";return b.beautify?beautifyHtml(c):c};"undefined"!=typeof exports&&(module.exports=Page);
/**
 * @param {object} Context
 * @return null
 */
Page.prototype.request = function (context) {
  // Compile any dynamic code
  // Execute any scraps of type server
  return false
  if (!this.get('head onrequest'))
    return null
  try {
    eval(this.get('head onrequest'))
  } catch (e) {
    if (e instanceof SyntaxError)
      console.log('Syntax error rendering onrequest %s', e.message)
    else
      console.log('Error rendering onrequest %s', e.message)
  }
}
