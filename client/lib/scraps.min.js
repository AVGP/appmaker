if("undefined"!=typeof exports)var Space=require("space"),fs=require("fs"),marked=require("marked");function Element(a,b){this.type=a;this.attrs=b||{};this.content="";return this}Element.prototype.addClass=function(a){this.attrs["class"]=this.attrs["class"]?this.attrs["class"]+(" "+a):a};Element.prototype.append=function(a){this.content+=a};Element.prototype.attr=function(a,b){this.attrs[a]=b};Element.prototype.html=function(a){this.content+=a};
Element.prototype.toHtml=function(){var a="<"+this.type,b;for(b in this.attrs)this.attrs.hasOwnProperty(b)&&(a+=" "+b+'="'+this.attrs[b]+'"');a+=">"+this.content;return a+="</"+this.type+">"};function Scrap(a,b){this.path=a;this.id=a.split(/ /g).pop();this.clear();b instanceof Space||(b=new Space(b));this.patch(b);var c=this.values.scraps;if(c instanceof Space)for(var d in c.keys){var g=c.keys[d];c.values[g]=new Scrap(a+" "+g,c.values[g])}return this}
Scrap.format=function(a,b){return"nl2br"===b?a.replace(/\n/g,"<br>"):"markdown"===b?marked(a):a};Scrap.getPointer=function(a,b){if(!a||"string"===typeof b||!b&&"undefined"===typeof window)return null;b||(b=window);var c=a.split("."),d=c.shift();return!(d in b)?null:!c.length?b[d]:Scrap.getPointer(c.join("."),b[d])};Scrap.replace=function(a,b){return a.replace(/\{\{([_a-zA-Z0-9\.]+)( [^\}]+)?\}\}/g,function(a,d,g){return Scrap.getPointer(d,b)||(g?g.substr(1):"")})};
Scrap.styleToCss=function(a,b,c){a+=" {\n";for(var d in b)b.hasOwnProperty(d)&&(a+="  "+d+" : "+b[d].toString().replace(/\;$/,"")+";\n");return Scrap.replace(a+"}\n",c)};Scrap.styleToInline=function(a,b){var c="",d;for(d in a)a.hasOwnProperty(d)&&(c+=d+": "+a[d].toString().replace(/\;$/,"")+"; ");return Scrap.replace(c,b)};Scrap.events="onblur onchange onclick oncontextmenu onenterkey onfocus onhold onkeydown onkeypress onkeyup onmousedown onmouseout onmouseover onmouseup onorientationchange onsubmit ontouchend ontouchmove ontouchstart".split(/ /);
Scrap.prototype=new Space;Scrap.prototype.clone=function(a){return new Scrap(a,this)};Scrap.prototype.selector=function(){return"#"+this.path.replace(/ /g," #")};Scrap.prototype.setContent=function(a){this.values.content&&this.div.html(Scrap.format(Scrap.replace(this.values.content,a),this.values.content_format));if(this.values.scraps)for(var b in this.values.scraps.keys)this.div.html(this.values.scraps.values[this.values.scraps.keys[b]].toHtml(a))};
Scrap.prototype.setElementType=function(a){type=this.values.type?this.values.type:"div";if(type.match(/^(checkbox|color|date|datetime|email|file|month|number|password|radio|range|search|tel|text|time|url|week)$/))this.div=new Element("input",{type:type});else if("ul"===type)this.div=new Element("ul"),this.setList(a);else if("inputbutton"===type)this.div=new Element("input",{type:"button"});else if("hidden"===type)this.div=new Element("input",{type:"hidden"});else if("list"===type)this.div=new Element("div"),
this.setList(a);else if("ol"===type)this.div=new Element("ol"),this.setList(a);else if("select"===type)this.div=new Element("select"),this.setOptions(a);else if("style"===type){if("style"===this.values.type){var b="",c=this.get("styles");if(c instanceof Space)for(var d in c.keys)var g=c.keys[d],b=b+Scrap.styleToCss(g,c.values[g].values,a);this.div=new Element("style");return this.div.html(b)}}else this.div=new Element(type);this.div.attr("id",this.id);b="checked class disabled draggable dropzone end for height href max maxlength min name origin pattern placeholder readonly rel required selected spellcheck src tabindex target title width value".split(/ /);
for(d in b)this.setProperty(b[d],a)};
Scrap.prototype.setList=function(a){if(!this.values.items||!this.values.item)return null;var b=this.values.item.toString(),c=this.values.items;"string"===typeof c&&c.match(/\{\{/)&&(c=Scrap.getPointer(c.replace(/\{|\}/g,""),a));"string"===typeof c&&(c=this.values.items.split(/ /g));if(!c)return null;this.values.items instanceof Space&&(c=this.values.items.values);var d="",g;for(g in c)if(c.hasOwnProperty(g)){var h={name:g,value:c[g]},e=b.replace(/\{\{([_a-z0-9\.]+)\}\}/gi,function(b,c){var d;return(d=
Scrap.getPointer(c,h))?d:Scrap.getPointer(c,a)}),e=new Space(e),f="";e.values.title&&(f+=' title="'+e.values.title+'"');e.values["class"]&&(f+=' class="'+e.values["class"]+'"');e.values.href&&(f+=' href="'+e.values.href+'"');e.values.draggable&&(f+=' draggable="'+e.values.draggable+'"');e.values.target&&(f+=' target="'+e.values.target+'"');e.values.onclick&&!this.noscript&&(f+=' onclick="'+e.values.onclick+'"');e.values.style&&(f+=' style="'+Scrap.styleToInline(e.values.style.values)+'"');e.values.value&&
(f+=' value="'+e.values.value+'"');d+="<"+(e.values.type?e.values.type:"li")+f+">"+(e.values.content?e.values.content:"")+"</"+(e.values.type?e.values.type:"li")+">"}this.div.append(d)};
Scrap.prototype.setOptions=function(a){var b=this.values.options;"string"===typeof b&&((b=Scrap.getPointer(b.replace(/\{|\}/g,""),a))||(b=this.values.options.split(/ /g)));if(!b)return!1;var c=!1;this.values.selectedoption&&(c=Scrap.replace(this.values.selectedoption,a));this.values.options instanceof Space&&(b=this.values.options.values);for(var d in b)b.hasOwnProperty(d)&&this.div.append(' <option value="'+d+'"'+(c===d?' selected="selected"':"")+">"+("object"==typeof b[d]?d:b[d])+"</option>\n")};
Scrap.prototype.setProperty=function(a,b){this.values[a]&&this.div.attr(a,Scrap.replace(this.values[a],b))};Scrap.prototype.setScript=function(){for(var a in Scrap.events){var b=Scrap.events[a];this.values[b]&&this.div.attr(b,this.values[b])}};Scrap.prototype.setStyle=function(a){if(!this.values.style)return null;if(!(this.values.style instanceof Space))return this.div.attr("style",this.values.style);this.div.attr("style",Scrap.styleToInline(this.values.style.values,a))};
Scrap.prototype.toHtml=function(a){this.setElementType(a);this.setContent(a);this.setStyle(a);this.setScript(a);return this.div.toHtml()};function Page(a){this.clear();a&&this.patch(a);this.loadScraps();return this}Page.prototype=new Space;Page.prototype.clone=function(){return new Page(this.values)};Page.prototype.loadScraps=function(){for(var a in this.keys){var b=this.keys[a];this.values[b]=new Scrap(b,this.values[b])}};Page.prototype.request=function(){return!1};
Page.prototype.toHtml=function(a){a||(a={});this.request(a);var b="<!doctype html>\n",c;for(c in this.keys){var d=this.keys[c];"true"!==this.values[d].values.draft&&(b+="\n  "+this.values[d].toHtml(a))}return b};"undefined"!=typeof exports&&(module.exports=Page);
/**
 * @param {object} Context
 * @return null
 */
Page.prototype.request = function (context) {
  // Compile any dynamic code
  // Execute any scraps of type server
  return false
  if (!this.get('head onrequest'))
    return null
  try {
    eval(this.get('head onrequest'))
  } catch (e) {
    if (e instanceof SyntaxError)
      console.log('Syntax error rendering onrequest %s', e.message)
    else
      console.log('Error rendering onrequest %s', e.message)
  }
}
